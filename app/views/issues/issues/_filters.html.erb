<% if controller_name == 'queries' %>
  <% title = "Query: #{query.name}" %>
<% else %>
  <% title = 'Filters' %>
<% end %>

<% if logged_in? %>
  <%= render 'issues/issues/filters/saved_queries', :queries => private_queries, :title => 'Your queries', :id => 'private' %>
<% end %>

<%= render 'issues/issues/filters/saved_queries', :queries => public_queries, :title => 'Public queries', :id => 'public' %>

<%= pull_box title, :id => 'issue-filters', :opened => query.active?, :class => query.active? ? 'active-issue-query' : nil do %>
  <div class="btn-group pull-box-header-buttons">
    <%= link_to '#', 'data-gts-toggle' => '#issue-filters-content', 'data-gts-toggle-type' => 'pullbox', :class => 'btn' do %>
      <span class="caret"></span>
    <% end %>
  </div>
  <div class="gts-content" id="issue-filters-content">
    <%= simple_form_for(query, :url => project_issues_path, :method => :get, :html => { :class => 'form-horizontal gts-issue-filters' }) do |f| %>
      <%= f.input :milestone_id, :collection => query.milestones,
        :label => 'Milestone', :include_blank => 'No milestone',
        :required => false, :input_html => { :name => :milestone_id } %>
      <div class="control-group">
        <%= f.label 'State', :required => false %>
        <div class="controls">
          <ul class="issue-states">
            <% %w(new open resolved invalid).each do |state| %>
              <li>
              <%= label_button(state, :tag => :label, :for => "state-#{state}", :active => query.state_active?(state)) do %>
                <%= check_box_tag('states[]', state, query.state_active?(state), :id => "state-#{state}") %>
              <% end %>
              </li>
            <% end %>
          </ul>
        </div>
      </div>
      <div class="control-group">
        <%= f.label 'Labels', :required => false %>
        <div class="controls">
          <ul class="issue-labels">
            <% query.labels.each do |label| %>
              <li>
                <%= label_button(label.name, :tag => :label, :for => "label-#{label.id}", :color => label.color, :active => query.label_active?(label)) do %>
                  <%= check_box_tag('label_ids[]', label.id, query.label_active?(label), :id => "label-#{label.id}") %>
                <% end %>
              </li>
            <% end %>
          </ul>
        </div>
      </div>
      <div class="row-fluid">
        <div class="span12">
          <div class="pull-right">
            <% if logged_in? && query.active? && controller_name != 'queries' # LOL I actually wrote that %>
              <%= link_to 'Save this query', '#save-query-modal', 'data-toggle' => 'modal', :class => 'btn' %>
            <% end %>
            <span data-behavior="submit-buttons">
              <%= link_to 'Show all', project_issues_path, :class => 'btn', :data => { :behavior => 'reset' } %>
              <%= link_to 'Filter', project_issues_path, :class => 'btn btn-primary', :data => { :behavior => 'filter' } %>
            </span>
          </div>
        </div>
      </div>
    <% end %>
  </div>
  <% if logged_in? %>
    <%= modal_box 'Save current issue query', 'save-query-modal' do %>
      <%= render 'issues/queries/form', :query => query %>
    <% end %>
  <% end %>
<% end %>
